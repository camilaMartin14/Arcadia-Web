<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Registrarse - Arcadia</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="css/styles.css">
</head>
<body data-bs-theme="dark">
  <div class="container mt-5">
    <div class="row justify-content-center">
      <div class="col-md-6">
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="d-flex justify-content-end">
              <button id="theme-toggle" class="btn btn-sm btn-secondary" aria-label="Cambiar tema">
                <i id="theme-icon" class="bi bi-sun-fill"></i>
              </button>
            </div>
            <h3 class="text-center mb-4">Registrarse</h3>
            <form id="registerForm">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">Nombre</label>
                  <input type="text" class="form-control" id="nombre" required>
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">Apellido</label>
                  <input type="text" class="form-control" id="apellido" required>
                </div>
              </div>

              <div class="mb-3">
                <label class="form-label">Nombre de Usuario</label>
                <input type="text" class="form-control" id="usuario" required>
              </div>

              <div class="mb-3">
                <label class="form-label">Contrase&ntilde;a</label>
                <div class="input-group">
                  <input
                    type="password"
                    class="form-control"
                    id="password"
                    required
                    autocomplete="new-password">
                  <button class="btn btn-outline-secondary" type="button" id="togglePassword" aria-label="Mostrar/Ocultar contraseña">
                    <i class="bi bi-eye"></i>
                  </button>
                </div>
              </div>

              <div class="mb-3">
                <label class="form-label">Confirmar contrase&ntilde;a</label>
                <div class="input-group">
                  <input
                    type="password"
                    class="form-control"
                    id="passwordConfirm"
                    required
                    autocomplete="new-password">
                  <button class="btn btn-outline-secondary" type="button" id="togglePasswordConfirm" aria-label="Mostrar/Ocultar confirmación">
                    <i class="bi bi-eye"></i>
                  </button>
                </div>
              </div>

              <div class="mb-3">
                <label class="form-label">Email</label>
                <input type="email" class="form-control" id="email" required>
              </div>

             
              <button type="submit" class="btn btn-success w-100">Crear cuenta</button>
            </form>
            <p class="mt-3 text-center">
              ¿Ya tenés cuenta? <a href="login.html">Iniciá sesión</a>
            </p>
            <div id="mensaje" class="text-center mt-3 text-danger"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const mensajeEstado = document.getElementById("mensaje");
    const passwordInput = document.getElementById("password");
    const passwordConfirmInput = document.getElementById("passwordConfirm");
    const togglePasswordBtn = document.getElementById("togglePassword");
    const togglePasswordConfirmBtn = document.getElementById("togglePasswordConfirm");
    
    function applyTheme(theme) {
        const body = document.body;
        const icon = document.getElementById('theme-icon');
        const toggleButton = document.getElementById('theme-toggle');

        body.setAttribute('data-bs-theme', theme);
        localStorage.setItem('tema', theme);

        if (icon) {
            if (theme === 'dark') {
                icon.className = 'bi bi-moon-stars-fill'; 
            } else {
                icon.className = 'bi bi-sun-fill';
            }
        }

        if (toggleButton) {
            if (theme === 'dark') {
                toggleButton.classList.remove('btn-secondary');
                toggleButton.classList.add('btn-outline-warning');
            } else {
                toggleButton.classList.remove('btn-outline-warning');
                toggleButton.classList.add('btn-secondary');
            }
        }
    }

    function toggleTheme() {
        const currentTheme = document.body.getAttribute('data-bs-theme') || 'dark';
        const newTheme = currentTheme === 'light' ? 'dark' : 'light';
        applyTheme(newTheme);
    }
    
    document.addEventListener("DOMContentLoaded", () => {
        const temaGuardado = localStorage.getItem("tema");
        const temaInicial = temaGuardado || 'dark';
        
        applyTheme(temaInicial);

        const toggleButton = document.getElementById('theme-toggle');
        if (toggleButton) {
            toggleButton.addEventListener('click', toggleTheme);
        }
    });

    document.addEventListener("DOMContentLoaded", () => {
      const temaGuardado = localStorage.getItem("tema");
      if (temaGuardado === "light") temaClaro();
      else temaOscuro();
    });

    function limpiarMensaje() {
      if (!mensajeEstado) return;
      mensajeEstado.textContent = "";
      mensajeEstado.classList.remove("text-success", "text-danger");
      delete mensajeEstado.dataset.source;
    }

    function mostrarMensaje(texto, tipo = "danger", origen = "general") {
      if (!mensajeEstado) return;
      mensajeEstado.textContent = texto;
      mensajeEstado.classList.remove("text-success", "text-danger");
      mensajeEstado.classList.add(tipo === "success" ? "text-success" : "text-danger");
      mensajeEstado.dataset.source = origen;
    }

    function obtenerMensajePassword(passwordRaw) {
      const password = passwordRaw ?? "";
      if (password.length < 8) {
        return "La contraseña debe tener al menos 8 caracteres.";
      }
      if (/\s/.test(password)) {
        return "La contraseña no puede contener espacios.";
      }
      if (!/\d/.test(password)) {
        return "La contraseña debe incluir al menos un número.";
      }
      if (/([a-z])\1\1/.test(password.toLowerCase())) {
        return "No se permiten más de dos letras iguales consecutivas en la contraseña.";
      }
      return "";
    }

    function validarPassword(input, mostrarEstado = false) {
      if (!input) return true;
      const error = obtenerMensajePassword(input.value || "");
      input.setCustomValidity(error);

      if (error) {
        if (mostrarEstado) {
          mostrarMensaje(error, "danger", "password");
        }
        return false;
      }

      if (mensajeEstado?.dataset.source === "password") {
        limpiarMensaje();
      }
      return true;
    }

    function validarConfirmPassword(passInput, confirmInput, mostrarEstado = false) {
      if (!passInput || !confirmInput) return true;
      const error = (confirmInput.value || "") === (passInput.value || "") ? "" : "Las contraseñas no coinciden.";
      confirmInput.setCustomValidity(error);
      if (error) {
        if (mostrarEstado) {
          mostrarMensaje(error, "danger", "passwordConfirm");
        }
        return false;
      }
      if (mensajeEstado?.dataset.source === "passwordConfirm") {
        limpiarMensaje();
      }
      return true;
    }

    if (passwordInput) {
      passwordInput.addEventListener("input", () => validarPassword(passwordInput));
    }

    togglePasswordBtn?.addEventListener("click", () => {
      const icon = togglePasswordBtn.querySelector('i');
      const visible = passwordInput?.type === 'text';
      if (passwordInput) passwordInput.type = visible ? 'password' : 'text';
      if (icon) icon.className = visible ? 'bi bi-eye' : 'bi bi-eye-slash';
    });

    if (passwordConfirmInput) {
      passwordConfirmInput.addEventListener("input", () => validarConfirmPassword(passwordInput, passwordConfirmInput));
    }

    togglePasswordConfirmBtn?.addEventListener("click", () => {
      const icon = togglePasswordConfirmBtn.querySelector('i');
      const visible = passwordConfirmInput?.type === 'text';
      if (passwordConfirmInput) passwordConfirmInput.type = visible ? 'password' : 'text';
      if (icon) icon.className = visible ? 'bi bi-eye' : 'bi bi-eye-slash';
    });

    // --- Registro ---
    const form = document.getElementById("registerForm");
    if (!form) {
      console.warn("Formulario de registro no encontrado.");
    } else {
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        limpiarMensaje();

        if (!passwordInput) {
        mostrarMensaje("No se encontró el campo contraseña en el formulario.", "danger");
        return;
      }

      if (!validarPassword(passwordInput, true)) {
        passwordInput.reportValidity();
        passwordInput.focus();
        return;
      }

      if (!validarConfirmPassword(passwordInput, passwordConfirmInput, true)) {
        passwordConfirmInput.reportValidity();
        passwordConfirmInput.focus();
        return;
      }

      const password = passwordInput.value;
      const email = document.getElementById("email").value;
      const nroDocInput = document.getElementById("nroDoc");
      const nroDoc = nroDocInput ? parseInt(nroDocInput.value, 10) : 1;

      if (!email.includes("@")) {
        mostrarMensaje("⚠️ Ingresá un email válido.", "danger");
        return;
      }

      if (nroDocInput && (isNaN(nroDoc) || nroDoc <= 0)) {
        mostrarMensaje("⚠️ Ingresá un número de documento válido.", "danger");
        return;
      }

      const nuevoCliente = {
        NombreUsuario: document.getElementById("usuario").value,
        Contrasena: password,
        Nombre: document.getElementById("nombre").value,
        Apellido: document.getElementById("apellido").value,
        NroDoc: nroDoc,
        IdTipoDoc: 1,
        IdSexo: 1,
        IdNacionalidad: 1,
        FechaNacimiento: "2000-01-01",
        IdBarrio: 1,
        Calle: "Sin datos",
        Nro: 0,
        Cp: "0000",
        Email: email
      };

      try {
        const res = await fetch("http://localhost:5157/api/cliente/registrar", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(nuevoCliente)
        });

        if (res.ok) {
          mostrarMensaje("✅ Registro exitoso. Redirigiendo...", "success", "server");
          setTimeout(() => window.location.href = "login.html", 2000);
        } else {
          const errorText = await res.text();
          mostrarMensaje(`❌ Error al registrarse: ${errorText}`, "danger", "server");
        }
      } catch (error) {
          mostrarMensaje("⚠️ No se pudo conectar con el servidor.", "danger", "server");
        }
      });
    }
  </script>
</body>
</html>

